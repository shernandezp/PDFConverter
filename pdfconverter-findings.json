{
  "project": "PDFConverter",
  "description": "C# library that converts DOCX and XLSX files to PDF using OpenXML SDK 3.4.1 + PdfSharp-MigraDoc 6.2.4",
  "targetFramework": "net10.0",
  "lastUpdated": "2025-07-26",

  "architecture": {
    "entryPoints": [
      "Converters.cs — public facade delegating to DocxConverter / XlsxConverter",
      "DocxConverter.cs — DOCX→PDF pipeline (~1200+ lines)",
      "XlsxConverter.cs — XLSX→PDF pipeline"
    ],
    "coreFiles": {
      "DocxConverter.cs": "Main DOCX conversion: page setup, body paragraphs, tables, images, VML textboxes, headers/footers",
      "WordHelpers.cs": "OpenXML parsing: paragraph/run formatting, style resolution, borders, conditional formatting, numbering",
      "WordTableRenderer.cs": "Table rendering with column scaling, cell content, borders, shading, conditional styles",
      "ConverterExtensions.cs": "Image extraction, emoji detection/segmentation, Roman numerals, temp file management",
      "OpenXmlHelpers.cs": "Font resolver (system + embedded Noto Emoji), image byte retrieval from document parts",
      "ParagraphFormat.cs": "Sealed record: Alignment, LeftIndent, RightIndent, FirstLineIndent, SpacingBefore/After, LineSpacing, LineRule, HasExplicit flags",
      "RunFormat.cs": "Sealed record: FontFamily, Color, Bold, Italic, Underline, Size — with ApplyTo(FormattedText)",
      "BorderInfo.cs": "Sealed record: Top/Bottom/Left/Right width+color+style + padding, with Empty singleton"
    },
    "testProject": "src/PDFConverter.Tests/ — 139 xUnit tests (unit + integration)"
  },

  "packages": {
    "DocumentFormat.OpenXml": "3.4.1",
    "PdfSharp-MigraDoc": "6.2.4",
    "System.Drawing.Common": "10.0.3",
    "xunit": "2.9.3 (test project)"
  },

  "criticalBugsFixed": [
    {
      "id": "BUG-001",
      "title": "GetStyleParagraphProperties returns null for all styles",
      "file": "WordHelpers.cs",
      "method": "GetStyleParagraphProperties",
      "cause": "StyleParagraphProperties.CloneNode(true) as ParagraphProperties always returns null because StyleParagraphProperties is NOT ParagraphProperties — they are different OpenXML types despite having the same child elements",
      "impact": "ALL style-based paragraph formatting (alignment, indentation, spacing from styles) was silently ignored",
      "fix": "Build a new ParagraphProperties() and AppendChild(child.CloneNode(true)) for each child of StyleParagraphProperties",
      "testCoverage": "GetStyleParagraphProperties_ReturnType_IsParagraphProperties_NotStyleParagraphProperties"
    },
    {
      "id": "BUG-002",
      "title": "GetStyleRunProperties returns null for all styles",
      "file": "WordHelpers.cs",
      "method": "GetStyleRunProperties",
      "cause": "Same as BUG-001: StyleRunProperties.CloneNode(true) as RunProperties always returns null",
      "impact": "ALL style-based run formatting (bold, italic, font, size, color from styles) was silently lost",
      "fix": "Build a new RunProperties() and AppendChild(child.CloneNode(true)) for each child of StyleRunProperties",
      "testCoverage": "GetStyleRunProperties_ReturnsProperties_WhenStyleExists, ResolveRunFormatting_FallsBackToStyle"
    },
    {
      "id": "BUG-003",
      "title": "LineSpacingRuleValues.ToString() returns garbage in OpenXml 3.x",
      "file": "WordHelpers.cs",
      "method": "GetParagraphFormatting",
      "cause": "In DocumentFormat.OpenXml 3.x, LineSpacingRuleValues is a struct, not an enum. Its ToString() returns 'LineSpacingRuleValues { }' instead of 'Exact' or 'AtLeast'. The code compared this string against 'exact'/'atleast' which never matched.",
      "impact": "Exact and AtLeast line spacing was treated as Auto/Multiple — dividing by 240 instead of 20, producing wildly wrong spacing values",
      "fix": "Compare against enum values directly (== LineSpacingRuleValues.Exact) and assign string constants 'Exact'/'AtLeast'/'Auto'",
      "testCoverage": "GetParagraphFormatting_ExactLineSpacing_ConvertsTwipsToPoints, GetParagraphFormatting_AtLeastLineSpacing_ConvertsTwipsToPoints"
    },
    {
      "id": "BUG-004",
      "title": "MigraDoc 6.x Row.Cells.Count returns 0",
      "file": "WordTableRenderer.cs",
      "cause": "In MigraDoc 6.x, Row.Cells.Count returns 0 before rendering. Code that iterated Cells by count found nothing. The guard 'if (colIdx >= mRow.Cells.Count) break;' always evaluated true, skipping EVERY cell.",
      "impact": "All table cells appeared empty in the PDF — the #1 user-reported issue that persisted for days",
      "fix": "Track the known column count from TableGrid and iterate cells by column index instead of Cells.Count. Changed to 'if (colIdx >= cols) break;'"
    },
    {
      "id": "BUG-005",
      "title": "RunFormat.ApplyTo replaced entire Font object, wiping size",
      "file": "RunFormat.cs",
      "method": "ApplyTo",
      "cause": "Original code did 'formatted.Font = new Font(FontFamily)' which replaced the entire Font object, wiping any previously set Size. Also, Size was set AFTER Font replacement so it was lost.",
      "impact": "Text could render at size 0 (invisible) or lose font size when a font family was applied",
      "fix": "Changed to 'formatted.Font.Name = FontFamily' (mutates existing Font) and set Size before Font.Name"
    },
    {
      "id": "BUG-006",
      "title": "Auto line spacing rendered as Exactly instead of Multiple",
      "file": "DocxConverter.cs",
      "cause": "Word's 'auto' lineRule (value/240 = multiple of font height) was being rendered with LineSpacingRule.Exactly using fontSize × multiple. This clips lines instead of spacing them proportionally.",
      "impact": "Lines appeared cramped — spacing between lines was shorter than in Word",
      "fix": "Changed to LineSpacingRule.Multiple with the raw multiple value (e.g., 1.079)"
    },
    {
      "id": "BUG-007",
      "title": "Empty paragraph spacing override wiped docDefaults",
      "file": "DocxConverter.cs",
      "cause": "Empty paragraphs had their line spacing overridden to 'AtLeast <fontSize>', which wiped out the Multiple spacing set from docDefaults.",
      "impact": "Paragraph spacing inconsistent with Word rendering",
      "fix": "Removed the empty paragraph line spacing override"
    },
    {
      "id": "BUG-008",
      "title": "Redundant spacer paragraph after every table",
      "file": "WordTableRenderer.cs",
      "cause": "Code added section.AddParagraph() after every table, but Word documents already have explicit empty paragraphs after tables — this doubled the vertical gap.",
      "impact": "Maq_Cert_Temp.docx rendered as 2 pages instead of 1",
      "fix": "Removed the redundant spacer paragraph"
    },
    {
      "id": "BUG-009",
      "title": "behindDoc anchor images stretched to full page",
      "file": "DocxConverter.cs",
      "cause": "Positioned behindDoc anchor images in body paragraphs were drawn as full-page background images, stretching small images (e.g., 136×45pt) to fill the entire page (612×792pt).",
      "impact": "Signature images in MessageTemplate_Temp.docx rendered as page-sized blurs",
      "fix": "Render positioned anchors inline at their correct extent size. Added OffsetXEmu/OffsetYEmu to ImageInfo for correct positioning."
    },
    {
      "id": "BUG-010",
      "title": "ProcessRun tab/text ordering wrong",
      "file": "DocxConverter.cs",
      "method": "ProcessRun",
      "cause": "ProcessRun iterated all W.Text elements first, then ChildElements for tabs/breaks. This meant tabs always appeared AFTER text regardless of XML order in the run.",
      "impact": "Tab-based columnar layouts in tripcontroltemp.docx were completely misaligned — underscored signature lines jumbled",
      "fix": "Changed to iterate ChildElements in document order, handling W.Text, W.TabChar, and W.Break inline"
    },
    {
      "id": "BUG-011",
      "title": "DrawingML hyperlink parsed as OpenXmlUnknownElement",
      "file": "WordTableRenderer.cs",
      "method": "RenderDrawingMLRow",
      "cause": "w:hyperlink inside a DrawingML paragraph (<a:p>) is parsed as OpenXmlUnknownElement, NOT as W.Hyperlink. Type checking with 'is W.Hyperlink' always returned false.",
      "impact": "Hyperlinks in CheckList_Temp.docx DrawingML table cells were invisible",
      "fix": "Match by LocalName == 'hyperlink' and NamespaceUri == wNs instead of type check. Extract r:id via GetAttribute('id', rNs)."
    },
    {
      "id": "BUG-012",
      "title": "ExcelTableRenderer font replacement wipes size/bold/italic",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (cell formatting)",
      "cause": "Same pattern as BUG-005: setting formatted.Font = new Font(...) replaced the entire Font object, wiping size and style already set",
      "impact": "All Excel cell text lost font size and bold/italic formatting",
      "fix": "Use formatted.Font.Name = cellStyle.FontFamily instead of replacing the Font object"
    },
    {
      "id": "BUG-013",
      "title": "MigraDoc GetMinMergedCell crash with MergeDown on all columns",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (merge handling)",
      "cause": "MigraDoc 6.x TableRenderer.GetMinMergedCell(int row) throws InvalidOperationException('Unexpected problem #1') when ALL cells in a row have MergeDown > 0. Occurs with vertical merges spanning same rows in every column.",
      "impact": "PDF rendering crashed for XLSX files with vertical merges across all columns of a row",
      "fix": "Workaround: disable MergeDown entirely. Only use MergeRight (horizontal merge). Vertical merge targets render as empty cells."
    },
    {
      "id": "BUG-014",
      "title": "MigraDoc PageWidth returns 0 when not explicitly set",
      "file": "XlsxConverter.cs",
      "method": "BuildRenderer (page setup)",
      "cause": "section.PageSetup.PageWidth.Point returns 0.0 in MigraDoc 6.x when page size is not explicitly set. MigraDoc internally defaults to A4 but the property reports 0 for inherited defaults.",
      "impact": "pageContentWidth = 0 - margins = negative value, producing negative scale factor and negative column widths. Every word rendered on its own line.",
      "fix": "Always set section.PageSetup.PageWidth and PageHeight explicitly from Excel's paperSize attribute (Letter default, A4 if paperSize=9)"
    },
    {
      "id": "BUG-015",
      "title": "Empty spacer columns expanded by image anchors",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (data bounds)",
      "cause": "Images anchored in columns before the data range (spacer columns A-C) incorrectly expanded minDataCol, including empty columns in the table",
      "impact": "Table included empty columns, wrong column proportions, excessive width",
      "fix": "Only expand column bounds for images within or after data columns. Spacer-column images placed at column 0 with full table width."
    },
    {
      "id": "BUG-016",
      "title": "Overlapping images in different rows render at wrong vertical position",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (image placement)",
      "cause": "In Excel, images float over cells. Two images in different rows but overlapping vertically (e.g., signature images at rows 26-30 and 27-32) were placed in separate table rows, appearing stacked instead of side-by-side.",
      "impact": "Side-by-side images appeared one above the other",
      "fix": "Detect overlapping image row ranges across different columns and merge them to the earliest row for same-row rendering."
    },
    {
      "id": "BUG-017",
      "title": "Connector shapes (signature lines) not rendered",
      "file": "ExcelHelpers.cs / ExcelTableRenderer.cs",
      "method": "GetConnectorLines / RenderTable",
      "cause": "GetImagesWithPositionFromWorksheet only extracted xdr:pic elements. Connector shapes (xdr:cxnSp) used for horizontal signature lines were completely ignored.",
      "impact": "Signature underlines (___________) missing from PDF output",
      "fix": "Added GetConnectorLines() to extract horizontal connector shapes. Rendered as underscore text in the corresponding table cells."
    },
    {
      "id": "BUG-018",
      "title": "Empty rows create excessive vertical gaps",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (row collapsing)",
      "cause": "Rows with no cell data, no images, and no merges used default 14.5pt height, creating large gaps (e.g., 7 empty rows = ~101pt gap between title and banner)",
      "impact": "Document layout had unwanted large vertical gaps",
      "fix": "Collapse consecutive empty rows (no data, images, connectors, or merges) to 2pt height. Protect rows within image spans from collapsing."
    },
    {
      "id": "BUG-019",
      "title": "Empty cell paragraphs inflate image row heights",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (cell rendering)",
      "cause": "Every cell always added a text paragraph with Font.Size=10 even when empty. In image cells, this 10pt paragraph added to the cell height, pushing content in adjacent cells down.",
      "impact": "Title and subtitle text pushed too far apart by inflated image row",
      "fix": "Set empty paragraph to Font.Size=1 with zero spacing. For rows with both text and images, clamp image height to single row height."
    },
    {
      "id": "BUG-020",
      "title": "OpenXml 3.x HorizontalAlignmentValues.ToString() returns garbage for Excel cell alignment",
      "file": "ExcelHelpers.cs",
      "method": "GetCellStyleInfo",
      "cause": "Using cf.Alignment.Horizontal.Value.ToString() returned 'HorizontalAlignmentValues { }' instead of 'center'. Same OpenXml 3.x enum ToString() bug as BUG-003 (line spacing) and BUG-009 (table style override).",
      "impact": "Footer text (and all centered/right-aligned cells) rendered left-aligned because the switch statement never matched 'center'",
      "fix": "Changed to cf.Alignment.Horizontal.InnerText which returns the raw XML attribute value ('center', 'right', etc.)"
    },
    {
      "id": "BUG-021",
      "title": "MigraDoc cell format alignment not propagated to added paragraphs",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (cell rendering)",
      "cause": "Setting target.Format.Alignment on the Cell only affects the cell's default format. Paragraphs added with target.AddParagraph() may not inherit this alignment in all cases.",
      "impact": "Even when cell alignment was correctly parsed, text paragraphs still rendered left-aligned",
      "fix": "Explicitly set para.Format.Alignment = target.Format.Alignment on every text paragraph added to the cell"
    },
    {
      "id": "BUG-022",
      "title": "Connector underscore lines used full span width instead of cell width",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (connector rendering)",
      "cause": "Connector lines spanning multiple columns (e.g., col2→col4) calculated underscore count from the total span width. When rendered at the starting cell (cFrom=0), the long underscore line overflowed the cell boundary.",
      "impact": "Left signature underscore line extended far beyond the table to the left, overlapping other content",
      "fix": "Changed to use only the starting cell's width (colWidths[c] * scaleFactor) for underscore count calculation"
    },
    {
      "id": "BUG-023",
      "title": "Merged image span rows protected from collapsing created excessive gaps",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (row collapsing)",
      "cause": "When two images overlap vertically and are merged to the same row, the earlier image at its original position still protected all its span rows from collapsing. The merged row auto-expands to fit both images, making the span protection unnecessary and creating large vertical gaps.",
      "impact": "65-83pt gap between signature images and 'Firma' text labels below",
      "fix": "Only protect span rows for solo images (rows with exactly one image). Merged image rows (multiple images) render entirely in the expanded row without needing span protection."
    },
    {
      "id": "BUG-024",
      "title": "Image row span height calculation used collapsed row heights instead of originals",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (image sizing)",
      "cause": "The imgRowSpanHeight calculation at image rendering time used rowHeights[] which had already been modified by the empty row collapsing logic. Zero-extent images (no cx/cy in anchors) that calculate height from row spans got tiny heights (5×2pt=10pt instead of 5×14.5pt=72.5pt).",
      "impact": "payroll_signature image (zero-extent anchor) rendered at 22.5pt height instead of 72.5pt, or disappeared entirely",
      "fix": "Save original row heights before collapsing into originalRowHeights[]. Use originalRowHeights in the image span height calculation."
    },
    {
      "id": "BUG-025",
      "title": "Image in row with explicit height and text in adjacent cells expands the row",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (image sizing)",
      "cause": "In Excel, images overflow into rows below without expanding the row height. MigraDoc cannot overflow — it expands the row to fit the image. When the row has an explicit height (e.g., 15.5pt) and a tall image (42.7pt), the row expands to 42.7pt, pushing text in adjacent cells far apart.",
      "impact": "Gap between 'CERTIFICADO DE LIMPIEZA' and 'R543...' was 44.4pt instead of ~17pt",
      "fix": "When the row has an explicit height (rowHeights[r] != null) and other cells in the row have text, clamp the image to effectiveRowHeight to prevent row expansion."
    },
    {
      "id": "BUG-026",
      "title": "Connector underscore lines rendered inline with text instead of above it",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (connector rendering)",
      "cause": "Connector shapes in Excel are drawn ON TOP of cells at their anchor position. When connectors and cell text share the same row, the connector underscores were rendered as paragraphs within the same cell, appearing mixed with or after the text.",
      "impact": "'Firma funcionario obra' text appeared above or beside the underscore lines instead of below them",
      "fix": "When a row has both connectors AND text data, render connectors in a dedicated table row inserted BEFORE the text row. Connectors in connector-only rows still render inline."
    },
    {
      "id": "BUG-027",
      "title": "Side-by-side images in merged rows have no spacing between them",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (image sizing)",
      "cause": "When multiple images are merged to the same row for side-by-side rendering, each image fills its entire cell width. In a borderless table, adjacent cells have zero spacing, making images appear touching.",
      "impact": "Signature images appeared too close together with no visual separation",
      "fix": "When multiple images share a row, reduce maxImgW by 8pt to create natural spacing between them."
    },
    {
      "id": "BUG-028",
      "title": "Image span rows unnecessarily protected from collapsing",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (row collapsing)",
      "cause": "All rows in an image's anchor span (FromRow to ToRow) were protected from collapsing. Since MigraDoc auto-expands the image's first row to fit the full image height, subsequent span rows don't need protection — they just create empty gaps.",
      "impact": "Large vertical gaps between images and text below (e.g., 65-83pt gap between signature images and 'Firma' labels)",
      "fix": "Only protect the image's assigned row (where it renders), not the subsequent span rows. Image height is calculated from originalRowHeights[] (pre-collapse values) to maintain correct sizing."
    },
    {
      "id": "BUG-029",
      "title": "Spacer images expand row height when sharing row with text",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (floating image rendering)",
      "cause": "In Excel, images can overflow into rows below their anchor row. MigraDoc cannot overflow images — it expands the row to fit. When a spacer-column image (e.g., logo spanning 3 rows = 42.7pt) shares a row with title text, the row expands to 44pt, pushing subsequent text far down.",
      "impact": "Title 'CERTIFICADO DE LIMPIEZA' was separated from subtitle 'R543...' by 44pt instead of the expected ~14pt",
      "fix": "Render spacer images that share rows with text as absolutely positioned floating images (section.AddImage with RelativeVertical.Page, WrapStyle.None) outside the table layout. This preserves the image at full size while keeping the table row at its Excel height."
    },
    {
      "id": "BUG-030",
      "title": "Floating image dimensions calculated from row/col span instead of EMU extents",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (floating image sizing)",
      "cause": "Floating images initially used column span width and row span height for sizing, but the OpenXML anchor has explicit EMU extents (cx/cy in xfrm.Extents) that define the correct dimensions. Using span-based calculations produced incorrect aspect ratios.",
      "impact": "Logo image appeared horizontally squished (48pt wide instead of 104.8pt)",
      "fix": "Prefer WidthEmu/HeightEmu from the image info when available (non-zero). Fall back to span-based calculation only when EMU extents are zero."
    },
    {
      "id": "BUG-031",
      "title": "Floating image span rows collapsed to minimal height",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (row collapsing)",
      "cause": "When spacer images are rendered as floating (outside the table), their span rows (below the anchor row) appear empty and get collapsed to 2pt. This eliminates the vertical space that the image visually occupies, causing the next image/content to overlap.",
      "impact": "Banner image overlapped the floating logo image because the gap rows were collapsed",
      "fix": "Protect the full row span of spacer images (FromRow to ToRow) from collapsing, not just the assigned render row. These rows must maintain their original heights to reserve vertical space for the floating image."
    },
    {
      "id": "BUG-032",
      "title": "Connector underscore lines visually merge into one continuous line",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (connector rendering)",
      "cause": "Two connector lines rendered as underscores in adjacent cells used (cellWidth - 16) / 4.5 character count. With cells touching edge-to-edge in a borderless table, the underscore lines appeared as one continuous line with no visible gap.",
      "impact": "Two separate signature lines ('Firma funcionario obra' and 'Firma funcionario SYE') appeared as a single continuous underscore line",
      "fix": "Reduced underscore count to 65% of cell width (cellWidth * 0.65 / 4.5), centered in each cell, creating a clear visual gap between adjacent cells' underscore lines."
    },
    {
      "id": "BUG-033",
      "title": "Firma text not centered under connector underscore lines",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (text alignment)",
      "cause": "When connectors are split into a dedicated row above the text row, the connector underscores are rendered with ParagraphAlignment.Center. However, the text row below ('Firma funcionario...') uses the Excel cell's alignment (typically left-aligned or general), causing misalignment.",
      "impact": "'Firma funcionario obra' and 'Firma funcionario SYE' labels were left-aligned while the underscore lines above were centered",
      "fix": "When a row has connectors AND text (connectors split to dedicated row above), force ParagraphAlignment.Center on text paragraphs in connector columns so labels align with underscore lines."
    },
    {
      "id": "BUG-034",
      "title": "Merged-away cells skipped entirely causing right/left border gaps",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (cell loop)",
      "cause": "Cells covered by a horizontal merge (mergedCells.Contains) were entirely skipped with 'continue', including their border application. This caused gaps in the right and left outer frame borders where merged-away cells should still emit border lines.",
      "impact": "Right border and left border of the table had visible gaps at merged-away cell rows (e.g., 4 right border gaps in EmailTemplate_MAQ_DETAIL.xlsx)",
      "fix": "Merged-away cells now apply borders via ApplyCellBorders() but skip content, alignment, and image rendering. The 'continue' statement is moved after border application."
    },
    {
      "id": "BUG-035",
      "title": "MigraDoc border extension across merged cells with inconsistent borders above",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (border extension detection + MergeRight application)",
      "cause": "MigraDoc renders cell borders at row boundaries using max(cell_above.bottom, cell_below.top) across ALL columns covered by a merged cell. When a wide merge (e.g., C22:I22) sits below rows with inconsistent bottom borders (e.g., C21:D21 and H21:I21 have borders, E21-G21 don't), MigraDoc extends the max border across the full merged width, creating a spurious full-width horizontal line.",
      "impact": "A full-width horizontal line appeared across the OBSERVACIONES row in EmailTemplate_MAQ_DETAIL.xlsx where only partial borders should exist",
      "fix": "Pre-compute border-extension merges where: (1) anchor cell has TopWidth==0, (2) row above has inconsistent bottom borders, (3) anchor column width ≥ 40pt. For flagged merges, skip MergeRight and simulate centering via LeftIndent = mergeWidth - anchorWidth (which works with ParagraphAlignment.Center because MigraDoc centers within cellWidth - leftIndent)."
    },
    {
      "id": "BUG-036",
      "title": "Images anchored in merged-away cells not rendered",
      "file": "ExcelTableRenderer.cs",
      "method": "RenderTable (image matching)",
      "cause": "Images whose fromCol falls within a merge range (e.g., col E inside merge D:H) are assigned to a merged-away cell. Since merged-away cells skip content rendering, these images were never rendered. The merge anchor cell only matched images with fromCol equal to its own column.",
      "impact": "Bottom signature images (2 of 3) were missing in EmailTemplate_MAQ_DETAIL.xlsx",
      "fix": "When processing a merge anchor cell, check if any images have fromCol within the merge range (fromCol > anchorCol AND fromCol <= mergeEndCol), not just equal to the anchor column."
    }
  ],

  "openXmlGotchas": [
    {
      "topic": "StyleParagraphProperties vs ParagraphProperties",
      "detail": "These are DIFFERENT OpenXML types. CloneNode(true) as ParagraphProperties returns null. Must manually build ParagraphProperties from children."
    },
    {
      "topic": "StyleRunProperties vs RunProperties",
      "detail": "Same issue as above. CloneNode(true) as RunProperties returns null. Must manually build RunProperties from children."
    },
    {
      "topic": "EnumValue<T>.Value.ToString() in OpenXml 3.x",
      "detail": "Struct-based enum values like LineSpacingRuleValues.ToString() return 'LineSpacingRuleValues { }' not the member name. Same for TableStyleOverrideValues.ToString() and HorizontalAlignmentValues.ToString(). Use .InnerText for the XML string or compare with == against enum constants. NEVER use .ToString() for comparisons. This bug was found THREE times: BUG-003 (line spacing), BUG-009 (table style override), BUG-020 (Excel cell alignment)."
    },
    {
      "topic": "OpenXML unit conversions",
      "formulas": {
        "twipsToPoints": "value / 20.0",
        "halfPointsToPoints": "value / 2.0 (font sizes: sz=24 → 12pt)",
        "emuToPoints": "value / 12700.0",
        "borderSizeToPoints": "value / 8.0 (eighths of a point)",
        "autoLineSpacingMultiple": "value / 240.0 (e.g., 276 → 1.15)",
        "exactAtLeastLineSpacing": "value / 20.0 (same as twips)",
        "srcRectCropPercent": "value / 100000.0 (thousandths of a percent)",
        "percentWidth": "(value / 5000.0) * 500.0",
        "defaultTabStop": "720 twips = 36pt"
      }
    },
    {
      "topic": "tblLook bitmask (old-style)",
      "detail": "Old Word documents use hex val attribute instead of boolean attributes. Bit 0x0020=firstRow, 0x0040=lastRow, 0x0080=firstColumn, 0x0100=lastColumn."
    },
    {
      "topic": "cnfStyle binary string (old-style)",
      "detail": "12-digit binary string where position 0=firstRow, 1=lastRow, 2=firstCol, 3=lastCol."
    },
    {
      "topic": "DrawingML namespace mixing in Word documents",
      "detail": "Some Word docs (especially programmatically generated ones) mix namespaces: a <w:tr> may contain <a:tc> (DrawingML) instead of <w:tc> (WordprocessingML). row.Elements<W.TableCell>() returns nothing for such rows — must check child elements by LocalName/NamespaceUri. DrawingML namespace: http://schemas.openxmlformats.org/drawingml/2006/main"
    },
    {
      "topic": "w:hyperlink inside DrawingML parsed as OpenXmlUnknownElement",
      "detail": "A w:hyperlink element inside <a:p> is NOT typed as W.Hyperlink — it's OpenXmlUnknownElement. Must match by LocalName == 'hyperlink' and extract r:id via GetAttribute('id', rNs)."
    },
    {
      "topic": "ProcessRun child ordering",
      "detail": "A <w:r> can contain <w:tab/> intermixed with <w:t>. Must iterate ChildElements in document order, NOT separate passes for text vs tabs. Otherwise tab positions will be wrong."
    },
    {
      "topic": "Multiple inline images in same paragraph",
      "detail": "Multiple <w:drawing> elements in the same Word paragraph should be added to the same MigraDoc paragraph (side-by-side). Creating separate paragraphs per image stacks them vertically."
    },
    {
      "topic": "Image file extension mismatch",
      "detail": "Word may store JPEG data with a .png extension (e.g., image1.png with FFD8 header). Always detect format from magic bytes, not file extension."
    }
  ],

  "migraDocGotchas": [
    {
      "topic": "Row.Cells.Count returns 0",
      "detail": "In MigraDoc 6.x, Row.Cells.Count is 0 before rendering (lazy initialization). However Cells[index] DOES work. Use the known column count from the source document."
    },
    {
      "topic": "Floating images",
      "detail": "Use section.AddImage() (not paragraph.AddImage()) with WrapStyle.Through, RelativeHorizontal.Page/RelativeVertical.Page, and absolute Left/Top coordinates. Y position needs TopMargin added since Word positions relative to paragraph but MigraDoc positions relative to page."
    },
    {
      "topic": "Font resolver must be set before any rendering",
      "detail": "Call GlobalFontSettings.FontResolver assignment before creating any Document. The EmbeddedFontResolver handles system fonts + embedded Noto Emoji."
    },
    {
      "topic": "No character width scaling",
      "detail": "MigraDoc doesn't support w:w (character width scaling). Text may render slightly different widths than Word."
    },
    {
      "topic": "LineSpacingRule.Exactly clips lines",
      "detail": "Exactly mode clips to the exact point value. Inappropriate for Word's 'auto' line spacing. Use LineSpacingRule.Multiple with the raw multiple value instead."
    },
    {
      "topic": "AddTab requires tab stop definitions",
      "detail": "paragraph.AddTab() produces no visible spacing unless tab stops are defined on paragraph.Format.TabStops. Must parse explicit <w:tabs> from pPr or add default 36pt stops."
    },
    {
      "topic": "HeaderDistance vs TopMargin overlap",
      "detail": "HeaderDistance = distance from page top to header content start. TopMargin = distance from page top to body content. If header images are taller than (TopMargin - HeaderDistance), body text overlaps header images. Must adjust TopMargin = HeaderDistance + maxImageHeight + buffer."
    },
    {
      "topic": "Color emoji not supported",
      "detail": "PdfSharp 6.x doesn't support color emoji fonts (COLR/CPAL). Noto Emoji renders monochrome glyphs only."
    },
    {
      "topic": "PageWidth returns 0 when not explicitly set",
      "detail": "section.PageSetup.PageWidth.Point returns 0.0 in MigraDoc 6.x when page size is inherited (not set on the section). MigraDoc internally uses A4 as default, but the property reports 0. ALWAYS set PageWidth and PageHeight explicitly before using them in calculations."
    },
    {
      "topic": "GetMinMergedCell crash with full-row MergeDown",
      "detail": "MigraDoc.Rendering.TableRenderer.GetMinMergedCell(int row) throws InvalidOperationException('Unexpected problem #1') when ALL cells in a row have MergeDown > 0. Workaround: avoid MergeDown entirely, use only MergeRight."
    },
    {
      "topic": "Cell.Format.Alignment not propagated to AddParagraph()",
      "detail": "Setting cell.Format.Alignment = ParagraphAlignment.Center only sets the cell's default format. Paragraphs added with cell.AddParagraph() may not inherit this alignment in all rendering scenarios. Always set para.Format.Alignment explicitly on each paragraph."
    },
    {
      "topic": "Floating images as section-level shapes for Excel overflow simulation",
      "detail": "Excel images can overflow into rows below their anchor. MigraDoc table cells cannot overflow. The workaround is to render such images as section.AddImage() with WrapStyle.None, RelativeVertical.Page, RelativeHorizontal.Page, and absolute Top/Left coordinates calculated from table layout (indent + cumulative row heights). The image floats over the table without affecting row heights."
    },
    {
      "topic": "Border extension across merged cells",
      "detail": "MigraDoc renders cell borders at row boundaries using max(cell_above.bottom, cell_below.top). For MERGED cells, this max is computed across ALL columns covered by the merge and rendered as a SINGLE line across the full merged width. For individual cells (no merge), the max is computed per-cell independently. This means a wide merge below rows with inconsistent borders creates spurious full-width lines. No API-level workaround exists (Width=0, Visible=false, white borders all fail). The only working fix is to skip MergeRight for the problematic merge and simulate centering via LeftIndent."
    }
  ],

  "featureImplementations": [
    {
      "feature": "VML Textbox Extraction",
      "path": "w:pict → v:group → v:shape → v:textbox → w:txbxContent",
      "methods": ["RenderVmlPicts", "RenderVmlTextBoxIntoCell", "RenderVmlTextBoxContent", "RenderInnerTableInCell"],
      "notes": "VML shapes with position:absolute and negative z-index are background elements. fillcolor attribute applied as paragraph shading. Side-by-side picts rendered as borderless MigraDoc table columns."
    },
    {
      "feature": "Floating Anchor Images",
      "detail": "Anchor images (wp:anchor) with behindDoc or positioned layout are rendered as section-level floating images with WrapStyle.Through at absolute coordinates. Pre-scanned before paragraph text processing to avoid affecting text flow."
    },
    {
      "feature": "Conditional Table Formatting",
      "detail": "Supports firstRow/lastRow/firstColumn/lastColumn shading, bold, white font from table styles (tblStylePr). Handles both new-style boolean attributes and old-style hex bitmask/binary string formats. Uses TblLookBit() and CnfStyleBit() helpers."
    },
    {
      "feature": "Emoji Rendering",
      "detail": "Embedded NotoEmoji-Regular.ttf font (SIL OFL). ContainsEmoji() detects BMP emoji (U+2600-27BF), surrogate pairs, ZWJ, variation selectors. SplitEmojiSegments() splits text for font switching."
    },
    {
      "feature": "Image Source Rect Cropping",
      "detail": "srcRect crop values (thousandths of percent) applied via System.Drawing.Bitmap.Clone with calculated rectangle. Falls back gracefully on non-Windows (System.Drawing.Bitmap is Windows-only)."
    },
    {
      "feature": "Right Indent and Hanging Indent",
      "detail": "RightIndent tracked in ParagraphFormat record. Hanging indent (w:ind w:hanging) produces negative FirstLineIndent. Style right indent preserved when inline pPr doesn't explicitly override."
    },
    {
      "feature": "Header/Footer Rendering",
      "detail": "Header images grouped per paragraph (multiple inline images from same Word paragraph onto one MigraDoc paragraph for side-by-side layout). srcRect cropping applied. Footer paragraphs rendered with formatting. Header distance from pgMar applied. TopMargin adjusted when header images overflow."
    },
    {
      "feature": "Landscape Orientation",
      "detail": "pgSz orient=landscape applied to section.PageSetup.Orientation."
    },
    {
      "feature": "Hyperlinks in Tables",
      "detail": "DrawingML table cells with hyperlinks (w:hyperlink → r:id) rendered as MigraDoc Hyperlink objects with blue color and underline. Uses LocalName/NamespaceUri matching for OpenXmlUnknownElement detection."
    },
    {
      "feature": "DrawingML Row Rendering",
      "detail": "RenderDrawingMLRow() method handles <a:tc> cells in table rows that use DrawingML namespace instead of WordprocessingML. Extracts text, formatting, and hyperlinks from <a:p> paragraphs."
    },
    {
      "feature": "Tab Stop Parsing",
      "detail": "Parses explicit <w:tabs> from paragraph pPr. When no explicit tabs defined, adds Word default tab stops every 36pt (720 twips). Tab stops are required for MigraDoc's AddTab() to produce visible spacing."
    },
    {
      "feature": "Document-Order Run Processing",
      "detail": "ProcessRun iterates ChildElements in document order, handling W.Text, W.TabChar, and W.Break inline. Critical for tab-based columnar layouts where tab position relative to text matters."
    },
    {
      "feature": "Body Anchor Images Inline",
      "detail": "Body paragraphs with <w:drawing> containing inline anchor images are rendered inline within the paragraph text, not as separate elements."
    },
    {
      "feature": "Tiny Placeholder Image Skip",
      "detail": "behindDoc anchor images < 500 bytes are skipped with a log warning. These are typically empty placeholder shapes that cause PdfSharp errors."
    },
    {
      "feature": "Image Format Detection from Magic Bytes",
      "detail": "GetImageExtension() checks magic bytes (FFD8=JPEG, 89504E47=PNG, 474946=GIF, 424D=BMP, 49492A/4D4D002A=TIFF) instead of relying on file extension. Word sometimes stores JPEG data with .png extension."
    },
    {
      "feature": "docDefaults Resolution",
      "detail": "docDefaults pPrDefault and rPrDefault are read from StyleDefinitionsPart as ultimate fallback in the style resolution chain. Provides default spacing, font family, and font size."
    }
  ],

  "knownLimitations": [
    {
      "issue": "Font substitution",
      "detail": "When a document uses fonts not installed on the system (e.g., 'Arial MT'), PdfSharp falls back to a default font with potentially different glyph widths. This can cause minor layout differences."
    },
    {
      "issue": "No character width scaling (w:w)",
      "detail": "MigraDoc doesn't support the w:w attribute. Text that Word compresses/expands to fit will render at normal width."
    },
    {
      "issue": "Single-word overflow in narrow cells",
      "detail": "Long single words (no break points) in narrow fixed-layout table columns may overflow. MigraDoc can't break within words."
    },
    {
      "issue": "Complex VML layouts",
      "detail": "Only basic VML textbox extraction is supported. Complex VML with overlapping shapes, rotated text, or advanced effects may not render correctly."
    },
    {
      "issue": "EMF/WMF images unsupported",
      "detail": "PdfSharp 6.x cannot render EMF or WMF vector images. These produce 'Unsupported image format' errors and are skipped. Common for background header images in some DOCX files."
    },
    {
      "issue": "Color emoji not rendered",
      "detail": "PdfSharp 6.x doesn't support COLR/CPAL color emoji fonts. Embedded Noto Emoji provides monochrome (outline) glyphs only."
    },
    {
      "issue": "srcRect cropping is Windows-only",
      "detail": "System.Drawing.Bitmap used for srcRect crop is Windows-only. On non-Windows, cropping falls back gracefully (uses uncropped image)."
    },
    {
      "issue": "TableStyleProperties.RunPropertiesBaseStyle",
      "detail": "Table style conditional formatting run properties use RunPropertiesBaseStyle (not the expected property name). This is a WordprocessingML naming quirk."
    },
    {
      "issue": "Spacer-column image sizing approximate",
      "detail": "When Excel images span columns outside the data range (spacer columns), the floating image position is approximated to the table's left edge. Minor misalignment may occur compared to the original Excel layout."
    }
  ],

  "testDocuments": {
    "Cert_Temp.docx": { "expectedPages": 1, "features": ["tables", "styles", "conditional formatting"] },
    "CheckList_Temp.docx": { "expectedPages": 2, "features": ["tables", "hyperlinks in tables", "multiple pages"] },
    "Maq_Cert_Temp.docx": { "expectedPages": 1, "features": ["header images", "page layout"] },
    "MessageTemplate_Temp.docx": { "expectedPages": 1, "features": ["emoji", "table styling", "positioned images"] },
    "tripcontroltemp.docx": { "expectedPages": 1, "features": ["header images with cropping", "tab stops", "underscored lines"] },
    "TripControl_Movexx.docx": { "expectedPages": 1, "features": ["VML textboxes", "floating anchor images", "nested tables in VML", "multi-column VML layout", "right indent", "hanging indent", "conditional formatting"] },
    "EmailTemplateSyE.xlsx": { "expectedPages": 1, "features": ["XLSX conversion", "cell formatting", "merged cells", "images with twoCellAnchor", "connector shapes as signature lines", "zero-extent images", "empty spacer columns", "page centering"] },
    "EmailTemplate_MAQ_DETAIL.xlsx": { "expectedPages": 1, "features": ["XLSX conversion", "merged cells with borders", "border extension detection", "images in merged-away cells", "centering simulation without merge", "24 merge ranges", "14 border definitions", "3 TwoCellAnchor images"] }
  },

  "testingMethodology": {
    "overview": "Each test document was converted to PDF, then the user opened both the original document (in Word/Excel) and the generated PDF side-by-side for visual comparison. The user reported specific mismatches, which were then investigated by inspecting the OpenXML structure, identifying the mapping gap, and fixing the converter code. After each fix, the conversion was re-run and the user visually confirmed the improvement. This cycle repeated until the user approved the output.",
    "process": [
      "1. Place the test document in src/PDFConverter/TestDocuments/",
      "2. Run conversion via TestConsole or integration tests to generate the PDF",
      "3. User opens the original DOCX/XLSX in Microsoft Word/Excel",
      "4. User opens the generated PDF in a PDF viewer (side-by-side comparison)",
      "5. User reports specific visual differences (e.g., 'table cells are empty', 'image is on the wrong side', 'text overlaps the image')",
      "6. Developer inspects the OpenXML structure of the document (unzip .docx, read document.xml, styles.xml, etc.)",
      "7. Developer traces the conversion pipeline to find where the mapping fails",
      "8. Fix is applied to the general converter code (never hardcoded to a specific file)",
      "9. Re-run conversion and user visually re-validates",
      "10. Repeat steps 5-9 until user approves the output",
      "11. Run ALL previous test documents to ensure no regressions (page count + visual spot-check)",
      "12. Save the final approved PDF alongside the source document as a reference baseline"
    ],
    "automatedValidation": {
      "tool": "xUnit 2.9.3 with Microsoft.NET.Test.Sdk",
      "totalTests": 139,
      "integrationTests": "Convert each test document via all 3 input overloads (file, stream, byte[]) + byte[] return overloads. Validate: no exceptions thrown, output file exists and is non-empty, PDF page count matches expected value, PDF header bytes are %PDF.",
      "unitTests": "Test individual parsing methods with in-memory OpenXML documents. Validate: style resolution chain, paragraph formatting extraction, run formatting extraction, border parsing, emoji detection, image format detection, Roman numeral conversion, conditional formatting detection.",
      "pageCountValidation": "PdfSharp.Pdf.IO.PdfReader.Open(path, PdfDocumentOpenMode.Import).PageCount",
      "referencePdfs": "Each test document has a .pdf file saved alongside it in TestDocuments/ representing the last approved output. These serve as visual baselines for future regression checks."
    },
    "openXmlInspection": {
      "method": "DOCX and XLSX files are OpenXML packages (ZIP containers). To inspect structure: rename to .zip, extract, and read the XML parts (document.xml, styles.xml, word/header1.xml, etc.). Alternatively, use DocumentFormat.OpenXml SDK to programmatically traverse the element tree.",
      "keyPartsDocx": [
        "word/document.xml — document body with paragraphs, tables, images",
        "word/styles.xml — named styles with basedOn inheritance chain",
        "word/header1.xml, word/footer1.xml — header/footer content",
        "word/_rels/document.xml.rels — relationships (images, hyperlinks)",
        "word/media/ — embedded image files"
      ],
      "keyPartsXlsx": [
        "xl/worksheets/sheet1.xml — cell data and formatting references",
        "xl/styles.xml — cell styles, fonts, fills, borders, number formats",
        "xl/sharedStrings.xml — shared string table",
        "xl/drawings/ — embedded images and chart references"
      ]
    }
  },

  "perFileTestingHistory": {
    "Cert_Temp.docx": {
      "issuesFound": [
        "Line spacing shorter than in Word — paragraphs appeared cramped in PDF",
        "docDefaults spacing not being applied as fallback"
      ],
      "userFeedback": [
        "Line spacing is too tight in the PDF"
      ],
      "rootCauses": [
        "Word's 'auto' lineRule (value 259, i.e. 259/240 = 1.079× multiple) was rendered with LineSpacingRule.Exactly instead of LineSpacingRule.Multiple — Exactly clips lines, Multiple spaces them proportionally",
        "Empty paragraph spacing override was wiping out the Multiple spacing set from docDefaults"
      ],
      "fixesApplied": [
        "Changed auto lineRule from Exactly to Multiple with correct multiple value",
        "Added docDefaults pPrDefault spacing as fallback when paragraphs have no explicit spacing",
        "Removed empty paragraph line spacing override"
      ],
      "finalState": "Renders to 1 page with correct line spacing matching Word output"
    },
    "CheckList_Temp.docx": {
      "issuesFound": [
        "ALL table cells appeared completely empty in the PDF",
        "Table header row missing background color (4BACC6) and white bold font from LightList-Accent5 style",
        "Bold text inside table showing as normal weight",
        "Hyperlink in the bottom table not visible",
        "DrawingML table rows (using <a:tc> instead of <w:tc>) not being processed at all"
      ],
      "userFeedback": [
        "Contents of tables from Word shows empty in PDF — it has been already several iterations on this problem for days",
        "The style of the head of the table is not there. The top row has a background and the font is white. Some bold text is also showing normal inside the table",
        "There should be one link in the table at the bottom, I don't see the link in the PDF"
      ],
      "rootCauses": [
        "BUG-004: MigraDoc 6.x Row.Cells.Count returns 0 before rendering — the guard 'if (colIdx >= mRow.Cells.Count) break;' always evaluated true, skipping EVERY cell",
        "Conditional formatting from table styles (tblStylePr with type='firstRow') was not being resolved — old-format tblLook used hex bitmask (0x01E0) instead of boolean attributes",
        "DrawingML rows contain <a:tc> cells in a different XML namespace — row.Elements<W.TableCell>() returned nothing",
        "w:hyperlink inside DrawingML <a:p> was parsed as OpenXmlUnknownElement, not W.Hyperlink"
      ],
      "fixesApplied": [
        "Changed cell iteration to use known column count from TableGrid instead of Cells.Count",
        "Added GetTableStyleConditionalFormatting() for firstRow/lastRow/firstColumn formatting",
        "Added old-format tblLook hex bitmask parsing (bit flags 0x0020, 0x0040, 0x0080, 0x0100)",
        "Added RenderDrawingMLRow() for <a:tc> cells with text, formatting, and hyperlink extraction",
        "Added hyperlink detection by LocalName/NamespaceUri matching instead of type check"
      ],
      "finalState": "All 3 tables render with full text, header row styling (blue background, white bold font), hyperlinks visible and clickable. 2 pages as expected."
    },
    "Maq_Cert_Temp.docx": {
      "issuesFound": [
        "PDF renders to 2 pages while Word shows 1 page — extra vertical space"
      ],
      "userFeedback": [
        "Page count regression — should be 1 page"
      ],
      "rootCauses": [
        "WordTableRenderer.RenderTable() added section.AddParagraph() after every table as a spacer, but Word documents already have explicit empty paragraphs after tables — this doubled the vertical gap"
      ],
      "fixesApplied": [
        "Removed the redundant spacer paragraph after tables"
      ],
      "finalState": "Renders to 1 page matching Word layout"
    },
    "MessageTemplate_Temp.docx": {
      "issuesFound": [
        "Anchor images with behindDoc=True stretched to full 612×792pt page instead of rendering at their actual size (136×45pt)",
        "Emoji characters rendering as boxes or missing glyphs",
        "Header row styling (shading, bold, white text) missing from table"
      ],
      "userFeedback": [
        "Image stretches across entire page",
        "Emoji showing as boxes",
        "Header styling missing"
      ],
      "rootCauses": [
        "BUG-009: Body paragraph behindDoc anchors were being drawn as full-page background images via XGraphics.DrawImage(0, 0, pageWidth, pageHeight) regardless of their actual extent size",
        "System fonts didn't include Segoe UI Symbol or Noto Emoji — no emoji font available for rendering",
        "Old-format cnfStyle (12-digit binary string) for conditional formatting was not being parsed"
      ],
      "fixesApplied": [
        "Render positioned anchors inline at their correct extent size with OffsetXEmu/OffsetYEmu positioning",
        "Embedded NotoEmoji-Regular.ttf (SIL OFL) as assembly resource with automatic font switching via ContainsEmoji() and SplitEmojiSegments()",
        "Added cnfStyle binary string parsing (position 0=firstRow, 1=lastRow, 2=firstCol, 3=lastCol)"
      ],
      "finalState": "Images render at correct size with proper z-order. Emoji render as monochrome glyphs. Header styling applied. 1 page."
    },
    "tripcontroltemp.docx": {
      "issuesFound": [
        "Image at the top malformed — body text overlapping header images",
        "Text formatting at the bottom lost — tab-based columnar layout (underscored signature lines) completely jumbled",
        "Multiple underscored lines (_______________) misaligned"
      ],
      "userFeedback": [
        "The image at the top after exporting to PDF gets malformed",
        "The format of the text at the bottom gets lost",
        "The text at the bottom still a bit messed up. See where there are multiple _______________",
        "The text at the top is overlapping the images"
      ],
      "rootCauses": [
        "Multiple inline images in the same Word paragraph were being split into separate MigraDoc paragraphs (stacked vertically instead of side-by-side)",
        "Header images with srcRect cropping were not being cropped — full uncropped image used",
        "Header images were taller (77.77pt) than the available space (TopMargin - HeaderDistance = 35.45pt), causing body text to overlap",
        "BUG-010: ProcessRun iterated all W.Text elements first, then ChildElements for tabs/breaks — tabs always appeared AFTER text regardless of XML order",
        "Tab stops were not being parsed from <w:tabs> in pPr, and no default tab stops were added"
      ],
      "fixesApplied": [
        "Group multiple inline images from same Word paragraph onto one MigraDoc paragraph for side-by-side layout",
        "Added ApplySrcRectCrop() using System.Drawing.Bitmap.Clone with calculated crop rectangle",
        "Added TopMargin adjustment: TopMargin = HeaderDistance + maxImageHeight + 5pt buffer when images overflow",
        "Changed ProcessRun to iterate ChildElements in document order, handling W.Text, W.TabChar, and W.Break inline",
        "Added tab stop parsing: explicit <w:tabs> resolution + fallback to Word default 36pt (720 twips) stops"
      ],
      "finalState": "Images positioned correctly without overlap. Tab-based columnar layout renders correctly. Underscored signature lines properly aligned. 1 page."
    },
    "TripControl_Movexx.docx": {
      "issuesFound": [
        "VML textbox content (OBSERVACIONES bullet list, company info) completely invisible",
        "Logo image rendering on wrong side (right instead of left)",
        "Company address text pushed down by floating image",
        "Right-aligned text ('Cra 35A # 15B 35- Edificio Prisma') had extra space at the end instead of flush right alignment",
        "Second table had many formatting issues — missing borders, wrong alignment",
        "{{transport}} text overflowing from the last table column"
      ],
      "userFeedback": [
        "This one is a bit more complex and it shows multiple issues",
        "The image at the top is in the wrong side",
        "The logo shows up in the correct position now, but I see the text at the right is being pushed down",
        "'Cra 35A # 15B 35- Edificio Prisma' should be aligned at the right, but there is some space at the end",
        "I am still see that line not aligned at the right. Plus, The second table has many formatting issues",
        "The font does not match, is that because the app didn't find it in the system and then used a default one?",
        "It is not a big deal, but the second '{{transport}}' is overflowing from the table"
      ],
      "rootCauses": [
        "VML textbox content path (w:pict → v:group → v:shape → v:textbox → w:txbxContent) was not being traversed at all",
        "BUG-001: GetStyleParagraphProperties returned null for ALL styles — CloneNode(true) as ParagraphProperties always returned null because StyleParagraphProperties is a different type",
        "BUG-003: LineSpacingRuleValues.ToString() returned 'LineSpacingRuleValues { }' instead of 'Exact' — comparison against 'exact'/'atleast' never matched",
        "Right indent (w:ind w:right) was not being parsed from paragraph properties",
        "Floating anchor images were not being pre-scanned and separated from text flow",
        "Font not installed on system (e.g., Arial MT) — PdfSharp substituted default font with different glyph widths",
        "{{transport}} text is a single long word in a narrow 63.6pt column — MigraDoc cannot break within words"
      ],
      "fixesApplied": [
        "Implemented full VML textbox extraction pipeline: RenderVmlPicts, RenderVmlTextBoxContent, RenderVmlTextBoxIntoCell, RenderInnerTableInCell",
        "Fixed GetStyleParagraphProperties to build new ParagraphProperties from StyleParagraphProperties children (BUG-001)",
        "Fixed GetStyleRunProperties with same pattern (BUG-002, found by unit tests)",
        "Fixed LineSpacingRuleValues comparison to use == instead of ToString() (BUG-003, found by unit tests)",
        "Added RightIndent to ParagraphFormat record and applied it in paragraph rendering",
        "Added anchor image pre-scanning with floating image positioning (WrapStyle.Through, absolute coordinates)",
        "Side-by-side VML picts rendered as borderless MigraDoc table columns with fillcolor shading"
      ],
      "finalState": "VML content visible with correct styling. Logo positioned correctly. Right alignment working. 1 page. Font substitution confirmed as expected (system font not installed). {{transport}} overflow is a known MigraDoc limitation with single-word content in narrow columns.",
      "knownRemainingIssue": "{{transport}} text (63.6pt column) overflows because MigraDoc cannot break within words — this is a MigraDoc limitation, not a converter bug"
    },
    "EmailTemplateSyE.xlsx": {
      "issuesFound": [
        "PDF output was 'a total mess' — cell widths completely wrong",
        "Every word rendered on its own line (word-per-line wrapping)",
        "Table left-aligned instead of centered",
        "Banner image too wide, pushed to second page",
        "Zero-extent image (payroll_signature) rendered at wrong size",
        "Title 'CERTIFICADO DE LIMPIEZA' too far from subtitle 'R543...' due to empty rows",
        "Title too close to logo image above",
        "Bottom signature images stacked vertically instead of side-by-side",
        "Missing '___________' signature lines (connector shapes not rendered)",
        "Logo image squished when clamped to row height (LockAspectRatio not set)",
        "Logo image pushed to separate row, breaking horizontal alignment with title text",
        "Connector underscore lines visually merge into one continuous line",
        "Firma text labels not centered under connector underscore lines",
        "Banner image overlaps logo when floating image span rows collapsed"
      ],
      "userFeedback": [
        "The PDF is a total mess, something is wrong with the width of the cells",
        "The PDF didn't improve at all. Did you generate it and compared it with the excel?",
        "Did you check the actual PDF?",
        "Much better, but one of the images is too big and was moved to another page. In the Excel, all the content is centered but the PDF shows all aligned to the left with no spacing",
        "The second line 'R543 (Versión 02– Febrero/22)' its too far from the first 'CERTIFICADO DE LIMPIEZA'. The image at the left bottom is under the one to the right. I don't see these characters '___________'",
        "The image at the top is malformed — don't keep repeating the same mistake",
        "The space between CERTIFICADO and R543 is too far",
        "The lines at the bottom now are separated but Firma should be centered",
        "The first paragraph is overlapping content at the top",
        "There should be a bit more space between the first and second image"
      ],
      "rootCauses": [
        "BUG-012: Font.Name replacement wiped size/bold/italic (same pattern as BUG-005)",
        "BUG-013: MigraDoc GetMinMergedCell crash when ALL cells in a row have MergeDown",
        "BUG-014: MigraDoc PageWidth returns 0 when not explicitly set → pageContentWidth = -28.8, scaleFactor = -0.096, negative column widths → word-per-line rendering",
        "BUG-015: Spacer columns A-C expanded by image anchors, adding empty columns to table",
        "BUG-016: Signature images at rows 26 and 27 placed in separate table rows instead of same row",
        "BUG-017: Connector shapes (xdr:cxnSp) not extracted — only xdr:pic was handled",
        "BUG-018: 7 empty rows between title and banner at default 14.5pt each = 101pt gap",
        "BUG-019: Empty cell paragraphs (Font.Size=10) inflated image row heights",
        "BUG-020: HorizontalAlignmentValues.ToString() returned garbage (same OpenXml 3.x enum bug)",
        "BUG-021: MigraDoc cell format alignment not propagated to AddParagraph()",
        "BUG-022: Connector underscore lines used full span width causing overflow",
        "BUG-023: Merged image span rows protected from collapsing created large gaps",
        "BUG-024: Image height calculated from collapsed row heights instead of originals",
        "BUG-025: Image expands row when adjacent cells have text (Excel overflows, MigraDoc can't)",
        "BUG-026: Connector underscores rendered inline with text instead of above",
        "BUG-027: Side-by-side images had no spacing between them",
        "BUG-028: Image span rows unnecessarily protected, creating empty gaps",
        "BUG-029: MigraDoc can't overflow images like Excel — spacer images in shared rows expanded row height",
        "BUG-030: Floating image used span-based dimensions instead of EMU extents",
        "BUG-031: Floating image span rows collapsed, removing vertical space for the floating image",
        "BUG-032: Adjacent connector underscore lines had no visual gap at cell boundaries",
        "BUG-033: Text alignment in connector rows not forced to center"
      ],
      "fixesApplied": [
        "Set page size explicitly from Excel paperSize attribute (BUG-014 fix)",
        "Read page margins and orientation from worksheet XML",
        "Removed hardcoded 'Sheet' header paragraph",
        "Disabled MergeDown workaround for BUG-013",
        "Excluded spacer columns from table bounds (BUG-015 fix)",
        "Centered table with LeftIndent = (pageWidth - tableWidth) / 2",
        "Clamped image widths to table/cell width",
        "Added ToRow/ToCol to ExcelImageInfo for row-span size calculation",
        "Merged overlapping images to same row for side-by-side rendering (BUG-016 fix)",
        "Added GetConnectorLines() and rendered as underscore text (BUG-017 fix)",
        "Collapsed empty rows to 2pt height, protected image-span rows (BUG-018 fix)",
        "Set empty cell paragraphs to 1pt with zero spacing (BUG-019 fix)",
        "Height-clamped images in text rows to single row height",
        "Fixed HorizontalAlignment parsing to use InnerText instead of Value.ToString() (BUG-020 fix)",
        "Added explicit para.Format.Alignment propagation from cell format (BUG-021 fix)",
        "Changed connector underscore count to use single cell width not span width (BUG-022 fix)",
        "Protected image span rows only for solo images, not merged image groups (BUG-023 fix)",
        "Saved original row heights before collapsing for image span height calculation (BUG-024 fix)",
        "Clamped image height when row has explicit height and text in other cells (BUG-025 fix)",
        "Rendered connectors in dedicated row above text when both share same row (BUG-026 fix)",
        "Added 8pt padding between side-by-side images in merged rows (BUG-027 fix)",
        "Simplified image span protection to only protect the assigned render row (BUG-028 fix)",
        "Spacer images sharing rows with text rendered as floating section-level images with absolute positioning (BUG-029 fix)",
        "Floating image dimensions from EMU extents (WidthEmu/HeightEmu) when available (BUG-030 fix)",
        "Full row span of spacer images protected from collapsing (BUG-031 fix)",
        "Connector underscore count reduced to 65% of cell width for visual separation (BUG-032 fix)",
        "Text paragraphs in connector columns forced to center alignment (BUG-033 fix)",
        "Empty row collapse minimum raised from 2pt to 6pt for better spacing"
      ],
      "pdfAnalysisMethod": "Created PdfSharp-based PDF analysis tool to read back generated PDFs using PdfReader.Open + ContentReader.ReadContent. Extracted PDF operators (cm for image transforms, Td/Tj for text positions, Tf for fonts). This was CRITICAL for discovering BUG-014 (negative column widths invisible to visual inspection).",
      "finalState": "1-page PDF with centered table, correct column proportions, 4 images (logo as floating absolute-positioned image at full 104.8×42.7pt size, banner full width, signature images side-by-side with padding), connector signature lines in dedicated row above centered Firma labels, proper title-subtitle spacing (13.6pt gap), floating image span rows preserved, empty rows collapsed to 6pt minimum, footer text centered."
    },
    "EmailTemplate_MAQ_DETAIL.xlsx": {
      "issuesFound": [
        "Right and left outer frame borders had gaps at merged-away cell rows",
        "Full-width horizontal line appeared across OBSERVACIONES row where only partial borders should exist",
        "Bottom signature images (2 of 3) were missing — anchored in merged-away cells",
        "OBSERVACIONES text lost centering when merge was skipped",
        "FIRMA text wrapped to multiple lines when anchor column too narrow without merge"
      ],
      "userFeedback": [
        "The conversion is almost perfect, but some border styles are missed or wrong",
        "You fixed the border, but now OBSERVACIONES is not centered, both Firma are not centered and the images at the bottom are not there anymore",
        "C-D 17 and H-I 17 have the same borders as C-D 21 and H-I 21, but the ones at the top don't show an additional border",
        "Looks better but FIRMA ENCARGADO OBRA and FIRMA OPERADOR are in three lines and two lines, it should be only one for each",
        "Good"
      ],
      "rootCauses": [
        "BUG-034: mergedCells.Contains() skipped ALL processing for merged-away cells, including border application",
        "BUG-035: MigraDoc computes max(cell_above.bottom, cell_below.top) across ALL columns of a merged cell, extending partial borders to full merged width",
        "BUG-036: Images at fromCol within a merge range (not at anchor column) were skipped because merge anchor cells only matched images with fromCol == anchorCol"
      ],
      "fixesApplied": [
        "Merged-away cells now apply borders but skip content/alignment/images (BUG-034 fix)",
        "Pre-compute border-extension merges and skip MergeRight, simulate centering via LeftIndent (BUG-035 fix)",
        "Anchor column width threshold (≥40pt) prevents narrow-cell merges from being skipped (BUG-035 refinement)",
        "Merge anchor cells match images from any column within their merge range (BUG-036 fix)"
      ],
      "finalState": "1-page PDF with continuous right/left border frame (no gaps), no spurious full-width lines, 3 images rendered, OBSERVACIONES centered, FIRMA labels on single lines within full-width merges."
    }
  },

  "styleResolutionOrder": {
    "paragraphProperties": [
      "1. Inline pPr on the paragraph",
      "2. Style paragraph properties (GetStyleParagraphProperties — walks basedOn chain)",
      "3. docDefaults pPrDefault"
    ],
    "runProperties": [
      "1. Inline rPr on the run",
      "2. Run style (rPr → rStyle → GetStyleRunProperties)",
      "3. Paragraph style run properties (pPr → pStyle → GetStyleRunProperties)",
      "4. docDefaults rPrDefault"
    ],
    "tableBorders": [
      "1. Cell-level borders (tcPr → tcBorders) override all",
      "2. Table-level inline borders (tblPr → tblBorders)",
      "3. Table style borders (tblPr → tblStyle → style → tblPr → tblBorders)",
      "4. InsideH/InsideV from table borders apply as defaults for internal cell edges"
    ],
    "conditionalFormatting": [
      "1. cnfStyle attribute on row/cell (new-style boolean or old-style binary string)",
      "2. tblLook attribute on table (new-style boolean or old-style hex bitmask) + positional check"
    ]
  }
}
